I"ç9<ul id="markdown-toc">
  <li><a href="#é—®é¢˜æè¿°" id="markdown-toc-é—®é¢˜æè¿°">é—®é¢˜æè¿°</a></li>
  <li><a href="#æ€è€ƒ" id="markdown-toc-æ€è€ƒ">æ€è€ƒ,</a></li>
  <li><a href="#æ ¸å¿ƒæ€è·¯æ¶‰åŠå…¬å¸ä»£ç -ä¸èƒ½ä¸Šä¼ code" id="markdown-toc-æ ¸å¿ƒæ€è·¯æ¶‰åŠå…¬å¸ä»£ç -ä¸èƒ½ä¸Šä¼ code">æ ¸å¿ƒæ€è·¯(æ¶‰åŠå…¬å¸ä»£ç , ä¸èƒ½ä¸Šä¼ code)</a></li>
</ul>

<blockquote>
  <p>å‰è¨€ä¹‹éœ€è¦äº†è§£çš„ä¸œè¥¿</p>
</blockquote>

<ul>
  <li>
    <p>MediaCodec
MediaCodecç±»Androidæä¾›çš„ç”¨äºè®¿é—®ä½å±‚å¤šåª’ä½“ç¼–/è§£ç å™¨æ¥å£ï¼Œå®ƒæ˜¯Androidä½å±‚å¤šåª’ä½“æ¶æ„çš„ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸ä¸MediaExtractorã€MediaMuxerã€AudioTrackç»“åˆä½¿ç”¨ï¼Œèƒ½å¤Ÿç¼–è§£ç è¯¸å¦‚H.264ã€H.265ã€AACã€3gpç­‰å¸¸è§çš„éŸ³è§†é¢‘æ ¼å¼ã€‚å¹¿ä¹‰è€Œè¨€ï¼ŒMediaCodecçš„å·¥ä½œåŸç†å°±æ˜¯å¤„ç†è¾“å…¥æ•°æ®ä»¥äº§ç”Ÿè¾“å‡ºæ•°æ®ã€‚å…·ä½“æ¥è¯´ï¼ŒMediaCodecåœ¨ç¼–è§£ç çš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ä¸€ç»„è¾“å…¥/è¾“å‡ºç¼“å­˜åŒºæ¥åŒæ­¥æˆ–å¼‚æ­¥å¤„ç†æ•°æ®ï¼šé¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘è·å–åˆ°çš„ç¼–è§£ç å™¨è¾“å…¥ç¼“å­˜åŒºå†™å…¥è¦ç¼–è§£ç çš„æ•°æ®å¹¶å°†å…¶æäº¤ç»™ç¼–è§£ç å™¨ï¼Œå¾…ç¼–è§£ç å™¨å¤„ç†å®Œæ¯•åå°†å…¶è½¬å­˜åˆ°ç¼–ç å™¨çš„è¾“å‡ºç¼“å­˜åŒºï¼ŒåŒæ—¶æ”¶å›å®¢æˆ·ç«¯å¯¹è¾“å…¥ç¼“å­˜åŒºçš„æ‰€æœ‰æƒï¼›ç„¶åï¼Œå®¢æˆ·ç«¯ä»è·å–åˆ°ç¼–è§£ç è¾“å‡ºç¼“å­˜åŒºè¯»å–ç¼–ç å¥½çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¾…å¤„ç†å®Œæ¯•åç¼–è§£ç å™¨æ”¶å›å®¢æˆ·ç«¯å¯¹è¾“å‡ºç¼“å­˜åŒºçš„æ‰€æœ‰æƒã€‚ä¸æ–­é‡å¤æ•´ä¸ªè¿‡ç¨‹ï¼Œç›´è‡³ç¼–ç å™¨åœæ­¢å·¥ä½œæˆ–è€…å¼‚å¸¸é€€å‡º</p>
  </li>
  <li>
    <p>MediaMuxer
å°±æ˜¯å¯¹éŸ³é¢‘å’Œè§†é¢‘çš„æ··åˆ. æ¥ç”ŸæˆMP4 æˆ– å…¶å®ƒæ ¼å¼çš„æ–‡ä»¶</p>
  </li>
</ul>

<p>æ²¡æœ‰æ•°æ®æº,æ¯”å¦‚æ˜¯ä»surfaceå‡ºæ¥çš„
MediaCodec is typically used like this in asynchronous mode:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MediaCodec</span> <span class="n">codec</span> <span class="o">=</span> <span class="nc">MediaCodec</span><span class="o">.</span><span class="na">createByCodecName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="nc">MediaFormat</span> <span class="n">mOutputFormat</span><span class="o">;</span> <span class="c1">// member variable</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">MediaCodec</span><span class="o">.</span><span class="na">Callback</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">onInputBufferAvailable</span><span class="o">(</span><span class="nc">MediaCodec</span> <span class="n">mc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">inputBufferId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ByteBuffer</span> <span class="n">inputBuffer</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getInputBuffer</span><span class="o">(</span><span class="n">inputBufferId</span><span class="o">);</span>
    <span class="c1">// fill inputBuffer with valid data</span>
    <span class="err">â€¦</span>
    <span class="n">codec</span><span class="o">.</span><span class="na">queueInputBuffer</span><span class="o">(</span><span class="n">inputBufferId</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">onOutputBufferAvailable</span><span class="o">(</span><span class="nc">MediaCodec</span> <span class="n">mc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">outputBufferId</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ByteBuffer</span> <span class="n">outputBuffer</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputBuffer</span><span class="o">(</span><span class="n">outputBufferId</span><span class="o">);</span>
    <span class="nc">MediaFormat</span> <span class="n">bufferFormat</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputFormat</span><span class="o">(</span><span class="n">outputBufferId</span><span class="o">);</span> <span class="c1">// option A</span>
    <span class="c1">// bufferFormat is equivalent to mOutputFormat</span>
    <span class="c1">// outputBuffer is ready to be processed or rendered.</span>
    <span class="err">â€¦</span>
    <span class="n">codec</span><span class="o">.</span><span class="na">releaseOutputBuffer</span><span class="o">(</span><span class="n">outputBufferId</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">onOutputFormatChanged</span><span class="o">(</span><span class="nc">MediaCodec</span> <span class="n">mc</span><span class="o">,</span> <span class="nc">MediaFormat</span> <span class="n">format</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Subsequent data will conform to new format.</span>
    <span class="c1">// Can ignore if using getOutputFormat(outputBufferId)</span>
    <span class="n">mOutputFormat</span> <span class="o">=</span> <span class="n">format</span><span class="o">;</span> <span class="c1">// option B</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="err">â€¦</span><span class="o">)</span> <span class="o">{</span>
    <span class="err">â€¦</span>
  <span class="o">}</span>
 <span class="o">});</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">format</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">);</span>
 <span class="n">mOutputFormat</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputFormat</span><span class="o">();</span> <span class="c1">// option B</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
 <span class="c1">// wait for processing to complete</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</code></pre></div></div>

<p>ä¸ªäººè®¤ä¸ºåœ¨æœ‰æ•°æ®æºçš„æƒ…å†µä¸‹ç”¨è¿™ä¸ª, æ¯”å¦‚å·²ç»æœ‰äº†å›¾ç‰‡è¦åˆæˆè§†é¢‘ä¹‹ç±»çš„
MediaCodec is typically used like this in synchronous mode:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MediaCodec</span> <span class="n">codec</span> <span class="o">=</span> <span class="nc">MediaCodec</span><span class="o">.</span><span class="na">createByCodecName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">format</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">);</span>
 <span class="nc">MediaFormat</span> <span class="n">outputFormat</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputFormat</span><span class="o">();</span> <span class="c1">// option B</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
 <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">inputBufferId</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">dequeueInputBuffer</span><span class="o">(</span><span class="n">timeoutUs</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">inputBufferId</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ByteBuffer</span> <span class="n">inputBuffer</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getInputBuffer</span><span class="o">(</span><span class="err">â€¦</span><span class="o">);</span>
    <span class="c1">// fill inputBuffer with valid data</span>
    <span class="err">â€¦</span>
    <span class="n">codec</span><span class="o">.</span><span class="na">queueInputBuffer</span><span class="o">(</span><span class="n">inputBufferId</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kt">int</span> <span class="n">outputBufferId</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">dequeueOutputBuffer</span><span class="o">(</span><span class="err">â€¦</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">outputBufferId</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ByteBuffer</span> <span class="n">outputBuffer</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputBuffer</span><span class="o">(</span><span class="n">outputBufferId</span><span class="o">);</span>
    <span class="nc">MediaFormat</span> <span class="n">bufferFormat</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputFormat</span><span class="o">(</span><span class="n">outputBufferId</span><span class="o">);</span> <span class="c1">// option A</span>
    <span class="c1">// bufferFormat is identical to outputFormat</span>
    <span class="c1">// outputBuffer is ready to be processed or rendered.</span>
    <span class="err">â€¦</span>
    <span class="n">codec</span><span class="o">.</span><span class="na">releaseOutputBuffer</span><span class="o">(</span><span class="n">outputBufferId</span><span class="o">,</span> <span class="err">â€¦</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">outputBufferId</span> <span class="o">==</span> <span class="nc">MediaCodec</span><span class="o">.</span><span class="na">INFO_OUTPUT_FORMAT_CHANGED</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Subsequent data will conform to new format.</span>
    <span class="c1">// Can ignore if using getOutputFormat(outputBufferId)</span>
    <span class="n">outputFormat</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="na">getOutputFormat</span><span class="o">();</span> <span class="c1">// option B</span>
  <span class="o">}</span>
 <span class="o">}</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
 <span class="n">codec</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</code></pre></div></div>

<blockquote>
  <p>é—®é¢˜ è¯·çœ‹ä¸‹å›¾, ä»Halä¸Šæ¥çš„æ•°æ®ç¬¬ä¸€ç§’çš„æ—¶å€™æ˜¯æ— æ•ˆçš„videoçš„, ç»“æŸçš„æ—¶å€™è¦æ±‚å¤šå½•ä¸€ç§’é’Ÿ</p>
</blockquote>

<p><img src="https://github.com/skypx/BlogResource/raw/master/camera/video_audio_sync.png" alt="avatar" /></p>

<h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h2>
<p>æ­£å¸¸æƒ…å†µä¸‹,å¦‚æœå½•åƒå¼€å¯çš„è¯,Videoå’ŒAudioæ˜¯åŒæ—¶ä¼ ä¸Šæ¥çš„, ç„¶ååŒæ—¶åˆæˆ, ç±»ä¼¼mediarecorder
è¿™æ ·çš„è¯å°±ä¸ç”¨ç®¡, è§†é¢‘å’ŒéŸ³é¢‘çš„åŒæ­¥é—®é¢˜äº†. å› ä¸ºåŸºæœ¬ä¸ä¼šæœ‰å»¶è¿Ÿ,
ä½†æ˜¯å‡å¦‚å¼€å§‹çš„ä¸€ç§’é’Ÿæˆ‘æ²¡æœ‰videoæ•°æ®.ä½†æ˜¯åœæ­¢çš„æ—¶å€™æ˜¯ä»¥audioåœæ­¢çš„, è¿™æ ·çš„è¯æˆ‘çš„è§†é¢‘ä¸å°±å°‘äº†
ä¸€ç§’çš„æ—¶é—´, å¹¶ä¸”å‰é¢çš„videoæ•°æ®æ˜¯åƒåœ¾å¸§æ•°æ®</p>

<h2 id="æ€è€ƒ">æ€è€ƒ,</h2>

<p>é‚£å‡å¦‚æˆ‘å¤šå½•ä¸€ç§’, å¹¶ä¸”è®©å‰é¢çš„åƒåœ¾å¸§å»æ‰åœ¨åˆæˆä¸å°±å¯ä»¥äº†,</p>

<h2 id="æ ¸å¿ƒæ€è·¯æ¶‰åŠå…¬å¸ä»£ç -ä¸èƒ½ä¸Šä¼ code">æ ¸å¿ƒæ€è·¯(æ¶‰åŠå…¬å¸ä»£ç , ä¸èƒ½ä¸Šä¼ code)</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">mFirstVideoFrameTimeUs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//136899194595</span>
                <span class="n">mFirstVideoFrameTimeUs</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">presentationTimeUs</span><span class="o">;</span>
                <span class="c1">//ç¬¬ä¸€å¸§ä¸º0</span>
                <span class="n">info</span><span class="o">.</span><span class="na">presentationTimeUs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="c1">//ç¬¬ä¸€å¸§è§£ç , return</span>
                <span class="n">queueBuffer</span><span class="o">()</span>
                <span class="k">return</span>
            <span class="o">}</span>

<span class="c1">//æ¯æ¬¡æ¥ç®—æ—¶é—´çš„gap 136899227943 è¿™ä¸ªæ•°åœ¨å¢å¤§,å¸§çš„æ—¶é—´æˆ³è‚¯å®šæ˜¯åœ¨å¢å¤§</span>
<span class="kt">long</span> <span class="n">timeSinceVideoStart</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">presentationTimeUs</span> <span class="o">-</span> <span class="n">mFirstVideoFrameTimeUs</span><span class="o">;</span>
<span class="c1">//33348 æ˜¯33æ¯«ç§’ æ¯”å¦‚1ç§’30å¸§, 1å¸§å°±æ˜¯33æ¯«ç§’å·¦å³</span>
<span class="n">info</span><span class="o">.</span><span class="na">presentationTimeUs</span> <span class="o">=</span> <span class="n">timeSinceVideoStart</span> <span class="o">-</span> <span class="n">mVideoOffset</span><span class="o">;</span>

<span class="err">æ¥ç€æˆ‘ä»¬å°±å¯ä»¥æ‹¿å‡ºæ¥ä¸€å‰¯è¿™æ ·çš„æ•°æ®</span>
<span class="mi">0</span>         <span class="mi">1</span>         <span class="mi">2</span>          <span class="mi">3</span>          <span class="mi">4</span>
<span class="mi">0</span>         <span class="mi">33348</span>     <span class="mi">66695</span>      <span class="mi">100042</span>     <span class="mi">133397</span>
<span class="err">æ¯ä¸€å¸§åˆ°ç¬¬ä¸€å¸§çš„æ—¶é—´</span>

</code></pre></div></div>
<p>ä¸ºä»€ä¹ˆè¦è®¡ç®—æ—¶é—´, å› ä¸ºæˆ‘ä»¬è®°å½•äº†å¼€å§‹çš„æ—¶é—´å’Œç»“æŸçš„æ—¶é—´,ç„¶åæˆ‘ä»¬å½•äº†å¤šé•¿æ—¶é—´ä¹ŸçŸ¥é“,åœæ­¢çš„æ—¶å€™æˆ‘ä»¬ä¸å°±å¯ä»¥è¾¾åˆ°å¤šå½•çš„ç›®çš„äº†.</p>
:ET