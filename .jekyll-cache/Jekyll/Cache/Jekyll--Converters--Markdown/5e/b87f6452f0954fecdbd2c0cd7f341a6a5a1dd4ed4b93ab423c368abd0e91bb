I"¨`<ul id="markdown-toc">
  <li><a href="#ä»€ä¹ˆæ˜¯v4l2è¿™ç¯‡æ–‡ç« åªæ˜¯é’ˆå¯¹androidè®¾å¤‡" id="markdown-toc-ä»€ä¹ˆæ˜¯v4l2è¿™ç¯‡æ–‡ç« åªæ˜¯é’ˆå¯¹androidè®¾å¤‡">ä»€ä¹ˆæ˜¯V4L2(è¿™ç¯‡æ–‡ç« åªæ˜¯é’ˆå¯¹Androidè®¾å¤‡)</a></li>
  <li><a href="#æ€ä¹ˆç”¨å‘¢" id="markdown-toc-æ€ä¹ˆç”¨å‘¢">æ€ä¹ˆç”¨å‘¢?</a></li>
</ul>

<blockquote>
  <p>æœ€è¿‘åœ¨åšè§†é¢‘é‡‡é›†æ–¹é¢çš„å·¥ä½œ, å¯¹V4L2ç¨å¾®ç ”ç©¶äº†ä¸‹ï¼Œå†™ä¸‹ä¸€äº›è‡ªå·±çš„å¿ƒå¾—å’Œä½“ä¼šï¼ŒåŒæ—¶åšä¸€ä¸‹æ€»ç»“,
å¦‚æœæœ‰é‚£æ–¹é¢å†™é”™çš„è¯è¯·å¤šå¤šæŒ‡æ•™</p>
</blockquote>

<h5 id="ä»€ä¹ˆæ˜¯v4l2è¿™ç¯‡æ–‡ç« åªæ˜¯é’ˆå¯¹androidè®¾å¤‡">ä»€ä¹ˆæ˜¯V4L2(è¿™ç¯‡æ–‡ç« åªæ˜¯é’ˆå¯¹Androidè®¾å¤‡)</h5>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ç¡¬ä»¶åƒåƒä¸‡ä¸‡,æ¯”å¦‚æœ‰Aå‚å®¶çš„æ‘„åƒå¤´ï¼ŒBå‚å®¶çš„æ‘„åƒå¤´,é‚£å¯¹åº”å¾—å°±æœ‰Aå‚å®¶æ‘„åƒå¤´é©±åŠ¨ï¼ŒBå‚å®¶<br />
æ‘„åƒå¤´çš„é©±åŠ¨ï¼Œé‚£HALå°±å¾—é€šè¿‡Aå‚å®¶é©±åŠ¨è·å–æ•°æ®ï¼ŒBå‚å®¶é©±åŠ¨è·å–æ•°æ®.é‚£æœ‰æ— æ•°å‚å®¶äº†ï¼Ÿæ‰€ä»¥å°±æŠ½è±¡å‡º<br />
æ¥äº†ä¸€å¥—é©±åŠ¨æ¡†æ¶ï¼Œä¸ç®¡ä½ é‚£ä¸ªå‚å®¶çš„æˆ‘æ‘„åƒå¤´ï¼Œä¸Šé¢åªç”¨è°ƒæ¥å£ï¼Œé€šè¿‡é©±åŠ¨æ¡†æ¶æ¥è·å–æ•°æ®.</p>

<p>å®˜æ–¹è§£é‡Š:</p>

<p><a href="https://en.wikipedia.org/wiki/Video4Linux">V4L2</a></p>

<p>ä¸‹é¢çš„æ˜¯æ€»ç»“çš„ç™½è¯:
Video4Linux2æ˜¯Linuxå†…æ ¸ä¸­å…³äºè§†é¢‘è®¾å¤‡çš„å†…æ ¸é©±åŠ¨æ¡†æ¶ï¼Œä¸ºä¸Šå±‚çš„è®¿é—®åº•å±‚çš„è§†é¢‘è®¾å¤‡æä¾›äº†ç»Ÿä¸€çš„æ¥å£ã€‚<br />
å‡¡æ˜¯å†…æ ¸ä¸­çš„å­ç³»ç»Ÿéƒ½æœ‰æŠ½è±¡åº•å±‚ç¡¬ä»¶çš„å·®å¼‚ï¼Œä¸ºä¸Šå±‚æä¾›ç»Ÿä¸€çš„æ¥å£å’Œæå–å‡ºå…¬å…±ä»£ç é¿å…ä»£ç å†—ä½™ç­‰å¥½å¤„ã€‚<br />
å°±åƒå…¬å¸çš„è€æ¿ä¸€èˆ¬éƒ½ä¸ä¼šç›´æ¥æ‰¾åº•å±‚çš„å‘˜å·¥è°ˆè¯ï¼Œè€Œæ˜¯æ‰¾éƒ¨é—¨ç»ç†äº†è§£æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å› ä¸ºåº•å±‚å±Œä¸äººæ•°å¤šï¼Œ<br />
æ„è§å„æœ‰ä¸åŒï¼Œæªè¾ä¹Ÿä¸å‡†ï¼Œéƒ¨é—¨ç»ç†ä¼šæŠŠæƒ…å†µæ±‡æ€»åå†å‘ä¸Šæ±‡æŠ¥ï¼›äºŒä¸ªæ˜¯è€æ¿æ—¶é—´å®è´µã€‚</p>

<p>cameraä¸­è¿ç”¨çš„æ¡†æ¶æ˜¯æ˜¯è¿™æ ·çš„:
ä½äºHALä¸‹å±‚, ä»¥åæˆ‘ä¼šåˆ†æv4l2åœ¨HALå±‚çš„è¿ç”¨è·å–æ•°æ®</p>

<p><img src="https://github.com/skypx/BlogResource/raw/master/v4l2/camerapic.jpg" alt="avatar" /></p>

<p>è‡³æ­¤æˆ‘ä»¬å¤§æ¦‚æ˜ç™½äº†V4L2å¤§æ¦‚æ˜¯åšä»€ä¹ˆçš„.</p>

<h5 id="æ€ä¹ˆç”¨å‘¢">æ€ä¹ˆç”¨å‘¢?</h5>
<p>æ€è€ƒ:: å‡å¦‚æˆ‘ä¸é€šè¿‡V4L2é‚£ä¹ˆæˆ‘æ€ä¹ˆè·å–cameraæ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®ä¿å­˜ä¸‹æ¥ï¼Œè§†é¢‘åº”è¯¥è·å–ä¸äº†ï¼Œå› ä¸º<br />
è§†é¢‘ä¼šåœ¨HALé‡Œé¢æŠŠä¸€å¸§ä¸€å¸§æ•°æ®ä¼ é€ç»™codecï¼Œç„¶åç»è¿‡ç¼–è§£ç ï¼Œæ‰ç”Ÿæˆè§†é¢‘ï¼Œæˆ‘ä»¬é€šè¿‡V4l2èƒ½è·å–åˆ°<br />
ä¸€å¸§ä¸€å¸§æ•°æ®,å¹¶ä¸”ä¿å­˜ä¸ºå›¾ç‰‡ï¼Œå…¶å®HALçš„æ•°æ®å°±æ˜¯é€šè¿‡v4l2æ‹¿åˆ°åŸå§‹æ•°æ®çš„ï¼Œç„¶åHALå±‚åœ¨ç»è¿‡ç®—æ³•<br />
ç­‰çš„å¤„ç†ï¼Œè¿”å›ç»™cameraservice,ç„¶åè¿”å›ç»™Appï¼ŒAppåœ¨å»ä¿å­˜ã€‚æ‰€ä»¥å°±ç”Ÿæˆäº†å›¾ç‰‡</p>

<p>ä¸€ä¸ªå¤§è‡´çš„æµç¨‹ç±»ä¼¼è¿™æ ·çš„
<img src="https://github.com/skypx/BlogResource/raw/master/v4l2/v4l2.jpg" alt="avatar" /></p>

<ol>
  <li>open device
å»open é©±åŠ¨èŠ‚ç‚¹çš„ä½ç½®, å› ä¸ºä¼šv4l2çš„é©±åŠ¨èŠ‚ç‚¹ä¼šæŒ‚è½½åœ¨<strong>/dev/video0</strong>ä¸‹é¢
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="o">(</span><span class="n">deviceName</span><span class="o">,</span> <span class="no">O_RDWR</span> <span class="o">|</span> <span class="no">O_NONBLOCK</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>init_device
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="n">v4l2_capability</span> <span class="n">cap</span><span class="o">;</span> <span class="c1">//è¿™ä¸ªè®¾å¤‡çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯è§†é¢‘è¾“å…¥è®¾å¤‡</span>
 <span class="n">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cropcap</span><span class="o">;</span> <span class="c1">//è£å‰ªèƒ½åŠ›</span>
 <span class="n">struct</span> <span class="n">v4l2_crop</span> <span class="n">crop</span><span class="o">;</span> <span class="c1">// è£å‰ª</span>
 <span class="n">struct</span> <span class="n">v4l2_format</span> <span class="n">fmt</span><span class="o">;</span>  <span class="c1">// è®¾ç½®è§†é¢‘æ•è·æ ¼å¼</span>
 <span class="n">struct</span> <span class="n">v4l2_input</span> <span class="n">input</span><span class="o">;</span> <span class="c1">//è§†é¢‘è¾“å…¥</span>

 <span class="err">ä¸€äº›å‚æ•°çš„æ„æ€</span>
 <span class="c1">// VIDIOC_REQBUFSï¼šåˆ†é…å†…å­˜</span>
 <span class="c1">// VIDIOC_QUERYBUFï¼šæŠŠVIDIOC_REQBUFSä¸­åˆ†é…çš„æ•°æ®ç¼“å­˜è½¬æ¢æˆç‰©ç†åœ°å€</span>
 <span class="c1">// VIDIOC_QUERYCAPï¼šæŸ¥è¯¢é©±åŠ¨åŠŸèƒ½</span>
 <span class="c1">// VIDIOC_ENUM_FMTï¼šè·å–å½“å‰é©±åŠ¨æ”¯æŒçš„è§†é¢‘æ ¼å¼</span>
 <span class="c1">// VIDIOC_S_FMTï¼šè®¾ç½®å½“å‰é©±åŠ¨çš„é¢‘æ•è·æ ¼å¼</span>
 <span class="c1">// VIDIOC_G_FMTï¼šè¯»å–å½“å‰é©±åŠ¨çš„é¢‘æ•è·æ ¼å¼</span>
 <span class="c1">// VIDIOC_TRY_FMTï¼šéªŒè¯å½“å‰é©±åŠ¨çš„æ˜¾ç¤ºæ ¼å¼</span>
 <span class="c1">// VIDIOC_CROPCAPï¼šæŸ¥è¯¢é©±åŠ¨çš„ä¿®å‰ªèƒ½åŠ›</span>
 <span class="c1">// VIDIOC_S_CROPï¼šè®¾ç½®è§†é¢‘ä¿¡å·çš„è¾¹æ¡†</span>
 <span class="c1">// VIDIOC_G_CROPï¼šè¯»å–è§†é¢‘ä¿¡å·çš„è¾¹æ¡†</span>
 <span class="c1">// VIDIOC_QBUFï¼šæŠŠæ•°æ®ä»ç¼“å­˜ä¸­è¯»å–å‡ºæ¥</span>
 <span class="c1">// VIDIOC_DQBUFï¼šæŠŠæ•°æ®æ”¾å›ç¼“å­˜é˜Ÿåˆ—</span>
 <span class="c1">// VIDIOC_STREAMONï¼šå¼€å§‹è§†é¢‘æ˜¾ç¤ºå‡½æ•°</span>
 <span class="c1">// VIDIOC_STREAMOFFï¼šç»“æŸè§†é¢‘æ˜¾ç¤ºå‡½æ•°</span>
 <span class="c1">// VIDIOC_QUERYSTDï¼šæ£€æŸ¥å½“å‰è§†é¢‘è®¾å¤‡æ”¯æŒçš„æ ‡å‡†ï¼Œä¾‹å¦‚PALæˆ–NTSCã€‚</span>

 <span class="c1">//æŸ¥è¯¢èƒ½åŠ›</span>
 <span class="k">if</span> <span class="o">(-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">px_ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_QUERYCAP</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="o">)){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_QUERYCAP ERROR  "</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(!(</span><span class="n">cap</span><span class="o">.</span><span class="na">capabilities</span> <span class="o">&amp;</span> <span class="no">V4L2_CAP_VIDEO_CAPTURE</span><span class="o">)){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"can't capture for V4L2_CAP_VIDEO_CAPTURE"</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(!(</span><span class="n">cap</span><span class="o">.</span><span class="na">capabilities</span> <span class="o">&amp;</span> <span class="no">V4L2_CAP_STREAMING</span><span class="o">))</span> <span class="o">{</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"V4L2_CAP_STREAMING error"</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="c1">//æŠŠç»“æ„ä½“æ‰€å çš„å†…å­˜å…¨éƒ¨åˆå§‹åŒ–ä¸º0, æ–¹ä¾¿ä»¥åçš„èµ‹å€¼æ“ä½œ</span>
 <span class="c1">//è¿™ä¸ªåœ°æ–¹å¯ä»¥å®šä¹‰ä¸€ä¸ªå®å‡½æ•°æš‚æ—¶å…ˆè¿™æ ·</span>
 <span class="n">memset</span><span class="o">(&amp;</span><span class="n">input</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">struct</span> <span class="n">v4l2_input</span><span class="o">));</span>
 <span class="n">memset</span><span class="o">(&amp;</span><span class="n">cropcap</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">struct</span> <span class="n">v4l2_cropcap</span><span class="o">));</span>
 <span class="n">memset</span><span class="o">(&amp;</span><span class="n">fmt</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">struct</span> <span class="n">v4l2_format</span><span class="o">));</span>

 <span class="n">fmt</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="no">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="o">;</span>
 <span class="n">fmt</span><span class="o">.</span><span class="na">fmt</span><span class="o">.</span><span class="na">pix</span><span class="o">.</span><span class="na">width</span>       <span class="o">=</span> <span class="n">cap_rect</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>
 <span class="n">fmt</span><span class="o">.</span><span class="na">fmt</span><span class="o">.</span><span class="na">pix</span><span class="o">.</span><span class="na">height</span>      <span class="o">=</span> <span class="n">cap_rect</span><span class="o">.</span><span class="na">height</span><span class="o">;</span>
 <span class="n">fmt</span><span class="o">.</span><span class="na">fmt</span><span class="o">.</span><span class="na">pix</span><span class="o">.</span><span class="na">pixelformat</span> <span class="o">=</span> <span class="no">CAPTURE_PIXELFORMAT</span><span class="o">;</span>
 <span class="n">fmt</span><span class="o">.</span><span class="na">fmt</span><span class="o">.</span><span class="na">pix</span><span class="o">.</span><span class="na">field</span> <span class="o">=</span> <span class="no">V4L2_FIELD_INTERLACED_BT</span><span class="o">;</span>

 <span class="c1">//è®¾ç½®å›¾åƒçš„æ ¼å¼</span>
 <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_TRY_FMT</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_TRY_FMT error"</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="n">result</span> <span class="o">=</span> <span class="n">ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_S_FMT</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">);</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_S_FMT error"</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="n">memset</span><span class="o">(&amp;</span><span class="n">crop</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">struct</span> <span class="n">v4l2_crop</span><span class="o">));</span>
 <span class="n">crop</span><span class="o">.</span><span class="na">type</span>     <span class="o">=</span> <span class="no">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="o">;</span>
 <span class="n">crop</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">left</span>   <span class="o">=</span> <span class="n">cropcap</span><span class="o">.</span><span class="na">defrect</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
 <span class="n">crop</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">top</span>    <span class="o">=</span> <span class="n">cropcap</span><span class="o">.</span><span class="na">defrect</span><span class="o">.</span><span class="na">top</span><span class="o">;</span>
 <span class="n">crop</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">width</span>  <span class="o">=</span> <span class="n">cropcap</span><span class="o">.</span><span class="na">defrect</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>
 <span class="n">crop</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">.</span><span class="na">defrect</span><span class="o">.</span><span class="na">height</span><span class="o">;</span>

 <span class="n">result</span> <span class="o">=</span> <span class="n">ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_S_CROP</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_S_CROP error"</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>init_userptr
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">SLOGD</span><span class="o">(</span><span class="s">"sky init userptr"</span><span class="o">);</span>
 <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
 <span class="n">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="n">req</span><span class="o">;</span>
 <span class="n">memset</span><span class="o">(&amp;</span><span class="n">req</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">struct</span> <span class="n">v4l2_requestbuffers</span><span class="o">));</span>

 <span class="n">req</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="no">USE_BUF_COUNT</span><span class="o">;</span> <span class="c1">// buffer size if 4</span>
 <span class="n">req</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="no">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="o">;</span> <span class="c1">// video capture type</span>
 <span class="n">req</span><span class="o">.</span><span class="na">memory</span> <span class="o">=</span> <span class="no">V4L2_MEMORY_MMAP</span><span class="o">;</span> <span class="c1">//mmap æ–¹å¼</span>

 <span class="n">result</span> <span class="o">=</span> <span class="n">px_ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_REQBUFS</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">);</span> <span class="c1">//ç”³è¯·ç©ºé—´</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"insufficient buf memory\n"</span><span class="o">);</span> <span class="c1">//ä¸è¶³çš„</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">count</span> <span class="o">&gt;</span> <span class="no">USE_BUF_COUNT</span><span class="o">){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"request buf memory\n"</span><span class="o">);</span> <span class="c1">//ç”³è¯·error</span>
 <span class="o">}</span>

 <span class="n">buffers</span> <span class="o">=</span> <span class="o">(</span><span class="n">struct</span> <span class="n">buffer</span><span class="o">*)</span><span class="n">calloc</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">count</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(*</span><span class="n">buffers</span><span class="o">));</span>

 <span class="k">for</span> <span class="o">(</span><span class="n">n_buffers</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">n_buffers</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">.</span><span class="na">count</span><span class="o">;</span> <span class="n">n_buffers</span><span class="o">++)</span>
 <span class="o">{</span>
     <span class="n">struct</span> <span class="n">v4l2_buffer</span> <span class="n">buf</span><span class="o">;</span>
     <span class="c1">//clear buffer</span>
     <span class="n">memset</span><span class="o">(&amp;</span><span class="n">buf</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">struct</span> <span class="n">v4l2_buffer</span><span class="o">));</span>

     <span class="n">buf</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="no">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="o">;</span>
     <span class="n">buf</span><span class="o">.</span><span class="na">memory</span> <span class="o">=</span> <span class="no">V4L2_MEMORY_MMAP</span><span class="o">;</span>
     <span class="n">buf</span><span class="o">.</span><span class="na">index</span>  <span class="o">=</span> <span class="n">n_buffers</span><span class="o">;</span>

     <span class="c1">//æŸ¥è¯¢åˆ†é…çš„bufferä¿¡æ¯</span>
     <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">px_ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_QUERYBUF</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">result</span><span class="o">)</span>
     <span class="o">{</span>
         <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_QUERYBUF error"</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="c1">//void *mmap(void *start, size_t length, int prot, int flags,</span>
     <span class="c1">//int fd, off_t offset);</span>
     <span class="c1">//start:: æ˜ å°„åŒºçš„å¼€å§‹åœ°å€</span>
     <span class="c1">//length:: æ˜ å°„åŒºçš„é•¿åº¦</span>
     <span class="c1">//prot :: æœŸæœ›çš„å†…å­˜ä¿æŠ¤æ ‡å¿—ï¼Œä¸èƒ½ä¸æ–‡ä»¶çš„æ‰“å¼€æ¨¡å¼å†²çª</span>
     <span class="c1">//flags:: æŒ‡å®šæ˜ å°„ç±»å‹</span>
     <span class="c1">//offsetï¼šè¢«æ˜ å°„å¯¹è±¡å†…å®¹çš„èµ·ç‚¹ã€‚</span>

     <span class="n">buffers</span><span class="o">[</span><span class="n">n_buffers</span><span class="o">].</span><span class="na">length</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
     <span class="n">buffers</span><span class="o">[</span><span class="n">n_buffers</span><span class="o">].</span><span class="na">start</span> <span class="o">=</span>
     <span class="n">mmap</span><span class="o">(</span><span class="no">NULL</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="no">PROT_READ</span> <span class="o">|</span> <span class="no">PROT_WRITE</span><span class="o">,</span> <span class="no">MAP_SHARED</span><span class="o">,</span> <span class="n">fd</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">m</span><span class="o">.</span><span class="na">offset</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>start_capturing VIDIOC_STREAMON ä»£è¡¨å¼€å§‹è·å–å›¾ç‰‡æµ
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="no">SLOGD</span><span class="o">(</span><span class="s">"sky start capturing"</span><span class="o">);</span>
 <span class="kd">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="o">;</span>
 <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
 <span class="c1">//n_buffers åœ¨åˆå§‹åŒ–bufferçš„æ—¶å€™å·²ç»è‡ªåŠ¨+1äº†</span>
 <span class="k">for</span> <span class="o">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_buffers</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
     <span class="n">struct</span> <span class="n">v4l2_buffer</span> <span class="n">buf</span><span class="o">;</span>
     <span class="n">memset</span><span class="o">(&amp;</span><span class="n">buf</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="n">sizeof</span><span class="o">(</span><span class="n">buf</span><span class="o">));</span>
     <span class="n">buf</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="no">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="o">;</span>
     <span class="n">buf</span><span class="o">.</span><span class="na">memory</span> <span class="o">=</span> <span class="no">V4L2_MEMORY_MMAP</span><span class="o">;</span>
     <span class="n">buf</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
     <span class="c1">//VIDIOC_QBUF æŠŠbufferæ”¾å…¥æ”¾è¿›è¾“å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…å¡«å……æ•°æ®</span>
     <span class="n">result</span> <span class="o">=</span> <span class="n">px_ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_QBUF</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">result</span><span class="o">){</span>
         <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_QBUF error"</span><span class="o">);</span>
         <span class="k">return</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
 <span class="n">type</span> <span class="o">=</span> <span class="no">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="o">;</span>
 <span class="c1">//å¼€å§‹</span>
 <span class="n">result</span> <span class="o">=</span> <span class="n">px_ioctrl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">VIDIOC_STREAMON</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">result</span><span class="o">){</span>
     <span class="no">SKY_LOG</span><span class="o">(</span><span class="s">"VIDIOC_STREAMON error"</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ä¸æ–­çš„loopæŸ¥è¯¢
```java
void mainloop()
{
 SLOGD(â€œsky start main loopâ€);
 unsigned int count;
 count = MAX_FRAME_COUNT;  //è·å–200å¸§æ•°æ®</p>

    <p>while (count â€“ &gt;0)
 {
     for (;;) {
         fd_set fds;
         struct timeval tv;
         int r;</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     FD_ZERO(&amp;fds);
     FD_SET(fd, &amp;fds);

     tv.tv_sec = 2;
     tv.tv_usec = 0;

     //æ£€æµ‹æ‘„åƒå¤´æ˜¯å¦æœ‰æ•°æ®å¯ä»¥è¯»å–
     //select å’Œ poll æ¥å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç›‘å¬æ˜¯å¦æœ‰æ•°æ®å¯è¯»ã€‚
     r = select(fd+1, &amp;fds, NULL, NULL, &amp;tv);

     if (-1 == r) {
         if (EINTR == errno)
             continue;
         SKY_LOG("system error");
     }

     if (0 == r) {
         SKY_LOG("select time out");
     }

     read_frame();


 }
</code></pre></div>    </div>

    <p>}</p>
  </li>
</ol>

<p>}</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6.å…³æ‰è®¾å¤‡
```java
void close_device()
{
    SLOGD("sky close device");
    int close_id = close(fd);

    if (-1 ==  close_id){
        SKY_LOG("close error");
    }
}
</code></pre></div></div>
<p><a href="https://github.com/skypx/v4l2AndDrm">Githubåœ°å€</a></p>
:ET