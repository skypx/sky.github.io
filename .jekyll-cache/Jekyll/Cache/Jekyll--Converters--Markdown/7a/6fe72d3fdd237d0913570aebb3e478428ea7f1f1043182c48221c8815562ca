I"É2<ul id="markdown-toc">
  <li><a href="#ä»€ä¹ˆæ˜¯zsl" id="markdown-toc-ä»€ä¹ˆæ˜¯zsl">ä»€ä¹ˆæ˜¯ZSL</a></li>
  <li><a href="#ä¸€normal-mode" id="markdown-toc-ä¸€normal-mode">ä¸€ï¼Normal modeï¼š</a></li>
  <li><a href="#äºŒ-zsl-mode" id="markdown-toc-äºŒ-zsl-mode">äºŒï¼ ZSL Modeï¼š</a></li>
  <li><a href="#zsl-åˆ†ä¸ºä¸¤ç§modesingle-shotburst-mode" id="markdown-toc-zsl-åˆ†ä¸ºä¸¤ç§modesingle-shotburst-mode">Zsl åˆ†ä¸ºä¸¤ç§modeï¼šsingle shotï¼›burst mode</a></li>
  <li><a href="#ä¸‰æ‹ç…§å…·ä½“å®ç°è¿‡ç¨‹" id="markdown-toc-ä¸‰æ‹ç…§å…·ä½“å®ç°è¿‡ç¨‹">ä¸‰ï¼æ‹ç…§å…·ä½“å®ç°è¿‡ç¨‹</a></li>
  <li><a href="#é’ˆå¯¹api1æ¥è¯´" id="markdown-toc-é’ˆå¯¹api1æ¥è¯´">é’ˆå¯¹API1æ¥è¯´</a></li>
  <li><a href="#é’ˆå¯¹api2æ¥è¯´" id="markdown-toc-é’ˆå¯¹api2æ¥è¯´">é’ˆå¯¹API2æ¥è¯´</a></li>
  <li><a href="#å…·ä½“çš„codeæ–¹å¼" id="markdown-toc-å…·ä½“çš„codeæ–¹å¼">å…·ä½“çš„codeæ–¹å¼</a></li>
  <li><a href="#æ€»ç»“" id="markdown-toc-æ€»ç»“">æ€»ç»“</a>    <ul>
      <li><a href="#ä¸‹æ­¥è®¡åˆ’-æŠ½å‡ºsnapdragon-camera2-zsl-éƒ¨åˆ†" id="markdown-toc-ä¸‹æ­¥è®¡åˆ’-æŠ½å‡ºsnapdragon-camera2-zsl-éƒ¨åˆ†">ä¸‹æ­¥è®¡åˆ’, æŠ½å‡ºsnapdragon, camera2 ZSL éƒ¨åˆ†</a></li>
    </ul>
  </li>
</ul>

<h1 id="ä»€ä¹ˆæ˜¯zsl">ä»€ä¹ˆæ˜¯ZSL</h1>
<ul>
  <li>
    <p>ZSL (zero shutter lag)ï¼šé›¶ç§’å»¶è¿Ÿ</p>
  </li>
  <li>
    <p>åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä½¿ç”¨æ‰‹æœºcameraæ‹ç…§çš„æ—¶å€™å¾€å¾€ä¼šæœ‰ä¸€äº›å»¶è¿Ÿçš„ä½“éªŒã€‚ZSLï¼Œå°±æ˜¯ä¸ºäº†æ¶ˆé™¤è¿™ç§å»¶è¿Ÿï¼Œæä¾›ä¸€ç§â€œæ‹å³è§†â€çš„ä½“éªŒè€Œè¢«å¼€å‘å‡ºæ¥ã€‚</p>
  </li>
</ul>

<h1 id="ä¸€normal-mode">ä¸€ï¼Normal modeï¼š</h1>
<ul>
  <li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ‹ç…§æµç¨‹å¦‚ä¸‹ï¼Œä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°data flow ä»¥åŠshutter lag ï¼ˆå»¶è¿Ÿï¼‰æ˜¯å¦‚ä½•äº§ç”Ÿçš„</li>
</ul>

<p><img src="https://github.com/skypx/BlogResource/raw/master/camera/normal_take_picture.png" alt="avatar" /></p>

<p><img src="https://github.com/skypx/BlogResource/raw/master/camera/normal_data_flow.png" alt="avatar" /></p>

<h1 id="äºŒ-zsl-mode">äºŒï¼ ZSL Modeï¼š</h1>

<p>é€šè¿‡zsl æŠ€æœ¯ï¼Œæœ€å¤§ç¨‹åº¦ä¸Šå‡å°äº†è¿™ç§å»¶è¿Ÿï¼Œå¦‚ä¸‹å›¾ï¼š
<img src="https://github.com/skypx/BlogResource/raw/master/camera/zsl_take_picture.png" alt="avatar" />
<img src="https://github.com/skypx/BlogResource/raw/master/camera/zsl_data_flow.png" alt="avatar" /></p>

<h1 id="zsl-åˆ†ä¸ºä¸¤ç§modesingle-shotburst-mode">Zsl åˆ†ä¸ºä¸¤ç§modeï¼šsingle shotï¼›burst mode</h1>

<ol>
  <li>single shotï¼š</li>
</ol>

<p>é¢„è§ˆä¹‹åï¼Œsensor å’ŒVFE ä¼šäº§ç”Ÿå¿«ç…§å’Œé¢„è§ˆå¸§ï¼Œå¹¶ä¸”ä¼šæŠŠæœ€æ–°çš„ä¸€äº›å¸§ä¿ç•™åœ¨å›¾åƒbufferä¸­ã€‚ä¸€æ—¦â€œå–å›¾â€äº‹ä»¶è¢«è§¦å‘ï¼Œç³»ç»Ÿå°±ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å†…ä»å›¾åƒbufferä¸­æŠŠç›¸å…³çš„å›¾åƒæ‰¾å‡ºå¹¶è¿”å›ç»™ç”¨æˆ·ï¼Œè¿™å°±æ˜¯ZSL,é›¶ç§’å»¶è¿Ÿã€‚</p>

<p><img src="https://github.com/skypx/BlogResource/raw/master/camera/zsl_single_shot.png" alt="avatar" /></p>

<ol>
  <li>burst shotï¼š</li>
</ol>

<p>Burst mode æ˜¯single shot ç‰¹å¾çš„è‡ªç„¶å»¶ä¼¸ã€‚æ­¤åŠŸèƒ½å…è®¸ç”¨æˆ·æ•è·çš„ä¸ä»…æ˜¯å½“å‰å¸§ï¼Œä½†ä¹Ÿæœ‰å‡ ä¸ªå¸§ä¹‹å‰å’Œä¹‹åçš„å½“å‰å¸§çš„å°‘æ•°å‡ ä¸ªå¸§ï¼Œä»è€Œæ•æ‰åˆ°ä¸€ä¸ªåºåˆ—çš„å›¾åƒåˆ°å†…å­˜ã€‚è¿™å°†ä¸ºç”¨æˆ·æä¾›ä¸åŒçš„å¿«ç…§æ—¶é—´ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªå¸§æ¥ä¿å­˜ã€‚åº”ç”¨äº†å¤šå°‘å¸§çš„é€‰æ‹©è‡ªç”±æ˜¯å¤šå°‘è¿½æº¯å¸§å’Œæœªæ¥å¸§åœ¨è®°å¿†çš„å±€é™æ€§ä¸Šï¼Œè¿½æº¯å’Œæœªæ¥å¸§æ˜¯ç›¸å¯¹äºçœŸæ­£çš„å¿«é—¨æ—¶é—´çš„ã€‚</p>

<p><img src="https://github.com/skypx/BlogResource/raw/master/camera/zsl_burst_shot.png" alt="avatar" /></p>

<h1 id="ä¸‰æ‹ç…§å…·ä½“å®ç°è¿‡ç¨‹">ä¸‰ï¼æ‹ç…§å…·ä½“å®ç°è¿‡ç¨‹</h1>

<ol>
  <li>
    <p>Implementation without ZSLï¼š
<img src="https://github.com/skypx/BlogResource/raw/master/camera/normal_hal.png" alt="avatar" /></p>
  </li>
  <li>
    <p>Implementation with ZSLï¼š
<img src="https://github.com/skypx/BlogResource/raw/master/camera/zsl_hal.png" alt="avatar" /></p>
  </li>
</ol>

<p>å‚è€ƒé“¾æ¥:</p>

<p><a href="http://blog.chinaunix.net/uid-7213935-id-5753468.html">http://blog.chinaunix.net/uid-7213935-id-5753468.html</a>
<a href="https://blog.csdn.net/kris_fei/article/details/77057473">https://blog.csdn.net/kris_fei/article/details/77057473</a></p>

<blockquote>
  <p>ä¸€ç¯‡å…³äºæ‘„åƒå¤´åŸºç¡€éƒ¨åˆ†çš„æ–‡ç« :é«˜é€šCameraæ¶æ„</p>
</blockquote>
<p><a href="https://www.cnblogs.com/whw19818/p/5853407.html">https://www.cnblogs.com/whw19818/p/5853407.html</a></p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<strong>ä¸‹é¢è¯´ä¸‹Codeçš„æ–¹å¼</strong>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</p>
<h1 id="é’ˆå¯¹api1æ¥è¯´">é’ˆå¯¹API1æ¥è¯´</h1>
<ul>
  <li>é«˜é€šä¼šæä¾›å…³äºZSLçš„patchç»™å‚å•†. å‚å•†é€šè¿‡è®¾ç½® <code class="highlighter-rouge">setZSLMode</code> é»˜è®¤æ˜¯éšè—çš„æ–¹æ³•. å…·ä½“å¯¹äºé˜Ÿåˆ—çš„ç»´æŠ¤
æ”¾åœ¨äº†Frameworkå±‚å»å¤„ç†</li>
</ul>

<h1 id="é’ˆå¯¹api2æ¥è¯´">é’ˆå¯¹API2æ¥è¯´</h1>
<ul>
  <li>
    <p>Goolgeå»ºè®®å¯¹äºç¼“å­˜é˜Ÿåˆ—çš„å¤„ç†æ”¾åœ¨App å±‚æ¥å¤„ç† å…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹çš„é“¾æ¥
<a href="http://androidxref.com/9.0.0_r3/search?q=%22zsl%22&amp;project=packages">Camera2 ZSL</a></p>

    <p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯éœ€è¦è®¾ç½®æ¨¡æ¿<code class="highlighter-rouge">TEMPLATE_ZERO_SHUTTER_LAG</code> æ¥é€šçŸ¥HALåˆ‡æ¢æ¨¡æ¿</p>
  </li>
</ul>

<h1 id="å…·ä½“çš„codeæ–¹å¼">å…·ä½“çš„codeæ–¹å¼</h1>

<ol>
  <li>åˆ›å»ºSessionçš„æ–¹å¼ <code class="highlighter-rouge">createReprocessableCaptureSessionByConfigurations</code>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">camera</span><span class="o">.</span><span class="na">createReprocessableCaptureSessionByConfigurations</span><span class="o">(</span><span class="n">inputConfiguration</span><span class="o">,</span> <span class="n">outputs</span><span class="o">,</span><span class="n">sessionListener</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>è®¾ç½®<code class="highlighter-rouge">InputConfiguration</code>, è¿˜æœ‰<code class="highlighter-rouge">ImageWrite</code>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nc">InputConfiguration</span> <span class="n">inputConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputConfiguration</span>
                           <span class="nc">Size</span><span class="o">.</span><span class="na">width</span><span class="o">(),</span> <span class="nc">Size</span><span class="o">.</span><span class="na">height</span><span class="o">(),</span>
                           <span class="nc">ImageFormat</span><span class="o">.</span><span class="na">YUV_420_888</span><span class="o">;</span>
</code></pre></div>    </div>
  </li>
  <li>åˆ›å»ºæ–°çš„ImageReaderæ¥é…ç½®å’ŒInputConfigurationä¸€æ ·çš„å‚æ•°
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nc">ImageReader</span> <span class="n">mZslImageReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImageReader</span><span class="o">(</span><span class="nc">Size</span><span class="o">.</span><span class="na">width</span><span class="o">(),</span> <span class="nc">Size</span><span class="o">.</span><span class="na">height</span><span class="o">(),</span>
                           <span class="nc">ImageFormat</span><span class="o">.</span><span class="na">PRIVATE</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>æŠŠzslIamgereaderä¼ å…¥setRepeatingBurst, è¿™æ ·å°±å¯ä»¥è·å–è¿™ä¸ªæµäº†
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nc">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">reqBuilder</span> <span class="o">=</span> <span class="n">cameraDevice</span><span class="o">.</span><span class="na">createCaptureRequest</span><span class="o">(</span><span class="n">templateType</span><span class="o">);</span>
  <span class="n">reqBuilder</span><span class="o">.</span><span class="na">addTarget</span><span class="o">(</span><span class="n">mZslImageReader</span><span class="o">.</span><span class="na">getSurface</span><span class="o">);</span>
  <span class="n">mCaptureSession</span><span class="o">.</span><span class="na">setRepeatingBurst</span><span class="o">(</span><span class="n">reqBuilder</span><span class="o">....);</span>
</code></pre></div>    </div>
  </li>
  <li>è®¾ç½®ZslImageReaderçš„callback. onImageAvailable å¯ç”¨çš„æ—¶å€™æ”¾å…¥å¯¹åˆ—
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Image</span><span class="o">&gt;</span> <span class="n">mQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Image</span><span class="o">&gt;();</span>
  <span class="n">mQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Image</span><span class="o">)</span>
</code></pre></div>    </div>
    <p><a href="http://androidxref.com/9.0.0_r3/xref/cts/tests/camera/utils/src/android/hardware/camera2/cts/CameraTestUtils.java#286">å‚è€ƒCTS</a></p>
  </li>
  <li>è®¾ç½®ImageWriter
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="err">è¿™ä¸ª</span><span class="n">surface</span><span class="err">å…¶å®å°±æ˜¯è®¾ç½®</span><span class="n">inputconfig</span><span class="err">çš„æ—¶å€™åº•å±‚åˆ›å»ºçš„</span><span class="n">surface</span>
  <span class="nc">ImageWriter</span> <span class="n">mImageWriter</span> <span class="o">=</span> <span class="nc">ImageWriter</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getInputSurface</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>æŠŠLinkedBlockingQueueé‡Œé¢çš„imageé€ç»™ä¸‹é¢å»é‡æ–°æ“ä½œ, åŒæ—¶æŠŠresultä¹Ÿæ”¾å…¥è¿›å»
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">mImageWriter</span><span class="o">.</span><span class="na">queueInputImage</span><span class="o">(</span><span class="n">mQueue</span><span class="o">.</span><span class="na">getImage</span><span class="o">());</span><span class="c1">//ä¼ªä»£ç </span>
  <span class="n">captureRequestBuilder</span> <span class="o">=</span> <span class="n">mCameraDevice</span><span class="o">.</span>
                           <span class="nf">createReprocessCaptureRequest</span><span class="o">(</span><span class="n">mQueue</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
  <li>é‡æ–°å»æ‹ç…§, ç”¨å›¾ç‰‡çš„ImageReader
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">captureRequestBuilder</span><span class="o">.</span><span class="na">addTarget</span><span class="o">(</span><span class="n">mCaptureImageReader</span><span class="o">.</span><span class="na">getSurface</span><span class="o">());</span>
  <span class="n">mCaptureSession</span><span class="o">.</span><span class="na">capture</span><span class="o">(</span><span class="n">captureRequestBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span>
                           <span class="n">captureRequestCallback</span><span class="o">,</span> <span class="n">mCameraDeviceHandler</span><span class="o">.</span><span class="na">getDeviceThreadHandler</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>æˆ‘æ•´ç†äº†ä¸€å¼ å›¾ç‰‡å¤§è‡´æµç¨‹æ˜¯è¿™æ ·çš„
  <img src="https://github.com/skypx/BlogResource/raw/master/camera/zslnew.png" alt="avatar" /></p>
</blockquote>

<p>## å‚è€ƒäº†CTSç›¸å…³ä»£ç 
  <a href="http://androidxref.com/9.0.0_r3/xref/cts/tests/camera/utils/src/android/hardware/camera2/cts/CameraTestUtils.java">CameraCts - CameraTestUtils</a></p>

<p><a href="http://androidxref.com/9.0.0_r3/xref/cts/tests/camera/src/android/hardware/camera2/cts/ReprocessCaptureTest.java">CameraCts - ReprocessCaptureTest</a></p>

<h1 id="æ€»ç»“">æ€»ç»“</h1>
<ul>
  <li>
    <p>ä¸ç®¡æ˜¯ç”¨API1 çš„æ–¹å¼è¿˜æ˜¯API2çš„æ–¹å¼å»ZSLæ‹ç…§. éƒ½æ˜¯ä¸ºäº†æå‡æ‹ç…§çš„é€Ÿåº¦, å’Œæ™®é€šçš„æ‹ç…§çš„è¾ƒå¤§åŒºåˆ«æ˜¯å…ˆå¤„ç†å’Œåå¤„ç†
æ™®é€šçš„æ‹ç…§æ˜¯æŠŠå›¾ç‰‡åœ¨HALå±‚å…ˆå¤„ç†ç™½å¹³è¡¡.é™å™ªç­‰çš„å¤„ç†. è€ŒZSLæ‹ç…§æ˜¯å…ˆè·å–YUVæ•°æ®,ç„¶ååœ¨è¿›è¡ŒInputConfigçš„åå¤„ç†
å…¶å®ImageWrite writeåˆ°äº†InputConfigé‡Œé¢</p>

    <h2 id="ä¸‹æ­¥è®¡åˆ’-æŠ½å‡ºsnapdragon-camera2-zsl-éƒ¨åˆ†">ä¸‹æ­¥è®¡åˆ’, æŠ½å‡ºsnapdragon, camera2 ZSL éƒ¨åˆ†</h2>
  </li>
</ul>
:ET